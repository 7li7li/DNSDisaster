# 使用说明 - 动态IP恢复版本

## 配置nya.trp.sh账户

你需要在配置文件中填入你的nya.trp.sh账户信息：

```json
{
  "IpProvider": {
    "Username": "你的用户名",
    "Password": "你的密码",
    "DeviceGroupId": 235
  }
}
```

## 工作原理说明

### 1. 初始化阶段
- 系统启动时调用nya.trp.sh API登录
- 获取设备组信息，提取当前IP地址
- 如果无法获取IP，系统会发送错误通知并停止

### 2. 正常监控阶段
- 每30秒检查主域名端口连通性
- 连接成功时重置失败计数
- 连接失败时增加失败计数

### 3. 故障转移阶段
- 连续失败达到阈值（默认3次）时触发
- 将DNS记录从A记录切换为CNAME指向备用域名
- 发送故障转移通知

### 4. 动态恢复检测阶段
- 每60秒调用nya.trp.sh API获取最新IP
- 检测IP是否发生变化，如有变化发送通知
- 测试新IP的端口连通性
- 如果新IP可用，自动切换回A记录

## 关键改进点

### 🔄 解决IP变化问题
原版本的问题：
- 使用固定的原始IP进行恢复检测
- 当服务不可用后IP发生变更时，无法检测到恢复

新版本的解决方案：
- 通过API实时获取最新IP地址
- 基于最新IP进行恢复检测
- 确保切换到真正可用的服务

### 📍 IP变化监控
- 实时监控IP地址变化
- IP变化时立即发送Telegram通知
- 帮助你了解服务IP的变化情况

### 🔧 智能IP提取
- 优先选择"电信"线路的IP地址
- 如果没有电信线路，选择第一个有效IP
- 支持复杂的connect_host格式解析

## 测试建议

### 1. 配置测试
```bash
# 确保配置正确
dotnet run
# 应该看到成功获取IP地址的日志
```

### 2. 故障转移测试
- 临时关闭目标服务
- 观察系统是否在3次失败后切换到CNAME
- 检查Cloudflare DNS记录是否正确更新

### 3. 恢复测试
- 重新启动目标服务（可能使用新IP）
- 观察系统是否检测到新IP并切换回A记录
- 验证DNS记录是否使用了新的IP地址

## 日志说明

### 正常运行日志
```
info: 开始DNS监控服务...
info: 成功获取认证token
info: 获取到初始IP地址: x.x.x.x
dbug: TCP连接到 domain:port 成功
```

### IP变化日志
```
info: 检测到IP变化: old.ip → new.ip
info: Telegram通知发送成功: 检测到IP变化...
```

### 故障转移日志
```
warn: 连接失败 #3/3 - domain:port
warn: 触发故障转移: 切换到备用域名
info: 成功切换到CNAME记录
```

### 恢复日志
```
info: 检测到服务恢复，准备切换回A记录，IP: new.ip
info: 成功恢复到A记录，IP: new.ip
```

## 故障排除

### 1. API认证失败
```
fail: 登录失败: Unauthorized/Forbidden
```
**解决**: 检查用户名和密码是否正确

### 2. 设备组未找到
```
fail: 未找到ID为 235 的设备组
```
**解决**: 检查DeviceGroupId是否正确

### 3. IP提取失败
```
fail: 无法从 connect_host 中提取有效IP
```
**解决**: 检查设备组的connect_host格式，可能需要调整IP提取逻辑

现在你的DNS灾难恢复系统具备了真正的动态恢复能力！