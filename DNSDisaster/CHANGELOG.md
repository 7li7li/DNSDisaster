# DNS灾难恢复系统 - 更新日志

## v2.0.0 - 动态IP恢复检测

### 重大改进

#### 🔄 动态IP恢复机制
- **问题**: 原版本使用固定的原始IP进行恢复检测，但服务不可用后IP可能会发生变更
- **解决方案**: 集成nya.trp.sh API，实时获取最新IP地址进行恢复检测

#### 🆕 新增功能

1. **nya.trp.sh API集成**
   - 自动登录获取认证token
   - 定期获取设备组信息
   - 智能提取IP地址（优先电信线路）
   - Token缓存机制减少API调用

2. **智能IP检测**
   - 实时监控IP地址变化
   - IP变化时发送Telegram通知
   - 基于最新IP进行服务可用性检测

3. **增强的恢复逻辑**
   - 不再依赖固定的原始IP
   - 动态获取当前可用IP
   - 确保切换到真正可用的服务

### 配置更新

新增 `IpProvider` 配置节：

```json
{
  "IpProvider": {
    "Username": "your_nya_trp_username",
    "Password": "your_nya_trp_password", 
    "DeviceGroupId": 235
  }
}
```

### 工作流程更新

#### 新的监控流程：
1. **初始化**: 通过API获取当前IP地址
2. **正常监控**: 检查主域名端口连通性
3. **故障转移**: 切换到CNAME备用域名
4. **动态恢复**: 
   - 定期通过API获取最新IP
   - 检测IP变化并通知
   - 测试新IP可用性
   - 自动切换回A记录

#### 通知增强：
- 📍 **IP变化通知**: 当检测到IP地址变化时发送通知
- 🔄 **恢复详情**: 包含具体的IP地址信息

### 技术改进

1. **HTTP客户端优化**
   - 正确的请求头设置
   - 异步HTTP调用
   - 错误处理和重试机制

2. **配置验证增强**
   - 新增IP提供商配置验证
   - 更详细的错误提示

3. **日志记录改进**
   - IP变化跟踪
   - API调用状态记录
   - 详细的恢复过程日志

### 兼容性

- ✅ 向后兼容现有配置
- ✅ 保持原有的故障转移逻辑
- ✅ 现有的Telegram和Cloudflare集成不变

### 使用建议

1. **配置nya.trp.sh账户信息**
2. **设置正确的DeviceGroupId**
3. **监控日志确保API调用正常**
4. **测试完整的故障转移和恢复流程**

这个更新解决了原始IP变化导致的恢复检测失效问题，使系统能够真正实现自动化的DNS灾难恢复。